<!DOCTYPE html>
<html lang="en-GB">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI Cloudflare App Builder</title>
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
				padding: 20px;
			}

			.container {
				width: 100%;
				max-width: 800px;
				background: white;
				border-radius: 16px;
				box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
				display: flex;
				flex-direction: column;
				height: 90vh;
				max-height: 700px;
			}

			.header {
				padding: 24px;
				border-bottom: 1px solid #e5e7eb;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border-radius: 16px 16px 0 0;
			}

			.header h1 {
				font-size: 24px;
				margin-bottom: 8px;
			}

			.header p {
				font-size: 14px;
				opacity: 0.9;
			}

			.chat-container {
				flex: 1;
				overflow-y: auto;
				padding: 24px;
				background: #f9fafb;
			}

			.message {
				margin-bottom: 16px;
				display: flex;
				animation: fadeIn 0.3s ease-in;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.message.user {
				justify-content: flex-end;
			}

			.message.assistant {
				justify-content: flex-start;
			}

			.message-content {
				max-width: 75%;
				padding: 12px 16px;
				border-radius: 12px;
				word-wrap: break-word;
				white-space: pre-wrap;
				overflow-wrap: break-word;
				line-height: 1.6;
			}

			.message-content pre {
				background: #f9fafb;
				border: 1px solid #e5e7eb;
				border-radius: 6px;
				padding: 12px;
				overflow-x: auto;
				margin: 8px 0;
				white-space: pre;
			}

			.message-content code {
				background: #f3f4f6;
				padding: 2px 6px;
				border-radius: 3px;
				font-family: 'Courier New', Courier, monospace;
				font-size: 13px;
			}

			.message-content pre code {
				background: none;
				padding: 0;
				display: block;
			}

			.message-content strong {
				font-weight: 600;
			}

			.message-content em {
				font-style: italic;
			}

			.message.user .message-content {
				background: #667eea;
				color: white;
			}

			.message.assistant .message-content {
				background: white;
				color: #1f2937;
				border: 1px solid #e5e7eb;
			}

			.input-container {
				padding: 20px;
				border-top: 1px solid #e5e7eb;
				background: white;
				border-radius: 0 0 16px 16px;
			}

			.input-wrapper {
				display: flex;
				gap: 12px;
				align-items: flex-end;
			}

			#messageInput {
				flex: 1;
				padding: 12px 16px;
				border: 2px solid #e5e7eb;
				border-radius: 8px;
				font-size: 14px;
				font-family: inherit;
				resize: none;
				min-height: 44px;
				max-height: 120px;
				outline: none;
				transition: border-color 0.2s;
			}

			#messageInput:focus {
				border-color: #667eea;
			}

			button {
				padding: 12px 24px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border: none;
				border-radius: 8px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: transform 0.2s, box-shadow 0.2s;
				white-space: nowrap;
			}

			button:hover:not(:disabled) {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			button:active:not(:disabled) {
				transform: translateY(0);
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.button-group {
				display: flex;
				gap: 8px;
			}

			#clearButton {
				padding: 12px 16px;
				background: #ef4444;
			}

			#clearButton:hover:not(:disabled) {
				box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
			}

			.loading {
				display: none;
				align-items: center;
				gap: 8px;
				color: #6b7280;
				font-size: 14px;
				padding: 12px 16px;
			}

			.loading.active {
				display: flex;
			}

			.spinner {
				width: 16px;
				height: 16px;
				border: 2px solid #e5e7eb;
				border-top: 2px solid #667eea;
				border-radius: 50%;
				animation: spin 0.8s linear infinite;
			}

			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}

			.empty-state {
				text-align: center;
				color: #6b7280;
				padding: 40px 20px;
			}

			.empty-state h2 {
				font-size: 20px;
				margin-bottom: 12px;
				color: #374151;
			}

			.empty-state p {
				font-size: 14px;
				line-height: 1.6;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>ðŸ¤– AI Cloudflare App Builder</h1>
				<p>Describe your idea, and I'll help you build it with Cloudflare Workers & AI</p>
			</div>

			<div class="chat-container" id="chatContainer">
				<div class="empty-state">
					<h2>Welcome!</h2>
					<p>I'm your AI assistant for building Cloudflare Workers applications.<br>
					Tell me what you'd like to build, and I'll help you design the architecture,<br>
					create file structures, and provide code examples.</p>
				</div>
			</div>

			<div class="loading" id="loadingIndicator">
				<div class="spinner"></div>
				<span>Thinking...</span>
			</div>

			<div class="input-container">
				<div class="input-wrapper">
					<textarea
						id="messageInput"
						placeholder="E.g., I want to build a URL shortener with analytics..."
						rows="1"
					></textarea>
					<div class="button-group">
						<button id="clearButton" title="Clear conversation">Clear</button>
						<button id="sendButton">Send</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			// Session management
			const SESSION_KEY = 'cf-ai-builder-session';
			let sessionId = localStorage.getItem(SESSION_KEY);

			// DOM elements
			const chatContainer = document.getElementById('chatContainer');
			const messageInput = document.getElementById('messageInput');
			const sendButton = document.getElementById('sendButton');
			const clearButton = document.getElementById('clearButton');
			const loadingIndicator = document.getElementById('loadingIndicator');

			// Auto-resize textarea
			messageInput.addEventListener('input', () => {
				messageInput.style.height = 'auto';
				messageInput.style.height = messageInput.scrollHeight + 'px';
			});

			// Add message to chat
			function addMessage(role, content) {
				// Remove empty state if present
				const emptyState = chatContainer.querySelector('.empty-state');
				if (emptyState) {
					emptyState.remove();
				}

				const messageDiv = document.createElement('div');
				messageDiv.className = `message ${role}`;

				const contentDiv = document.createElement('div');
				contentDiv.className = 'message-content';

				// Use innerHTML with proper escaping and formatting
				// Convert markdown-style code blocks and preserve line breaks
				const formattedContent = formatContent(content);
				contentDiv.innerHTML = formattedContent;

				messageDiv.appendChild(contentDiv);
				chatContainer.appendChild(messageDiv);

				// Scroll to bottom
				chatContainer.scrollTop = chatContainer.scrollHeight;
			}

			// Format content with basic markdown support
			function formatContent(text) {
				// Escape HTML
				let formatted = text
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;');

				// Convert markdown code blocks ```...```
				formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
					return `<pre><code>${code.trim()}</code></pre>`;
				});

				// Convert inline code `...`
				formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

				// Convert **bold**
				formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

				// Convert *italic*
				formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

				// Convert line breaks
				formatted = formatted.replace(/\n/g, '<br>');

				return formatted;
			}

			// Send message to API
			async function sendMessage() {
				const message = messageInput.value.trim();
				if (!message) return;

				// Disable input
				messageInput.disabled = true;
				sendButton.disabled = true;
				clearButton.disabled = true;
				loadingIndicator.classList.add('active');

				// Add user message to chat
				addMessage('user', message);
				messageInput.value = '';
				messageInput.style.height = 'auto';

				try {
					const response = await fetch('/api/chat', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							message,
							sessionId,
						}),
					});

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					const data = await response.json();

					// Store session ID
					if (data.sessionId) {
						sessionId = data.sessionId;
						localStorage.setItem(SESSION_KEY, sessionId);
					}

					// Add assistant response
					addMessage('assistant', data.reply);
				} catch (error) {
					console.error('Error:', error);
					addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
				} finally {
					// Re-enable input
					messageInput.disabled = false;
					sendButton.disabled = false;
					clearButton.disabled = false;
					loadingIndicator.classList.remove('active');
					messageInput.focus();
				}
			}

			// Clear conversation
			async function clearConversation() {
				if (!sessionId) {
					// Just clear the UI
					chatContainer.innerHTML = `
						<div class="empty-state">
							<h2>Welcome!</h2>
							<p>I'm your AI assistant for building Cloudflare Workers applications.<br>
							Tell me what you'd like to build, and I'll help you design the architecture,<br>
							create file structures, and provide code examples.</p>
						</div>
					`;
					return;
				}

				clearButton.disabled = true;

				try {
					await fetch('/api/clear', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ sessionId }),
					});

					// Clear UI
					chatContainer.innerHTML = `
						<div class="empty-state">
							<h2>Welcome!</h2>
							<p>I'm your AI assistant for building Cloudflare Workers applications.<br>
							Tell me what you'd like to build, and I'll help you design the architecture,<br>
							create file structures, and provide code examples.</p>
						</div>
					`;

					// Generate new session
					sessionId = null;
					localStorage.removeItem(SESSION_KEY);
				} catch (error) {
					console.error('Error clearing conversation:', error);
				} finally {
					clearButton.disabled = false;
				}
			}

			// Event listeners
			sendButton.addEventListener('click', sendMessage);
			clearButton.addEventListener('click', clearConversation);

			messageInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter' && !e.shiftKey) {
					e.preventDefault();
					sendMessage();
				}
			});

			// Focus input on load
			messageInput.focus();
		</script>
	</body>
</html>
